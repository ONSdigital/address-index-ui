{% macro customSaveAddressesToClient(params) %}

{# This macro is designed only to save the address information to local storage, not generate components #}
{# Provided that the addresses are handed through the nunjucks template as they previously have been #}
{# This script should only be run on a results page #}


{# Add the addresses matched into localStorage so they can be accessed by js elsewhere #}

  <script type="module">
    import { setGlobalValues, getPageLocalValues, setPageLocalValues } from '/static/js/f_helpers/local_storage_page_helpers.mjs';

    const matchedAddresses = []
    function addAddressToLargeList(addressInfo) {
      // Remove any null, blank or "" entries - so that we don't fill up local storage!
//      addressInfo = Object.fromEntries(
//        Object.entries(addressInfo).filter(([_, v]) => v !== '' && v != null)
//      );

      // Given a single address, add it to the array of addresses in js
      matchedAddresses.push(addressInfo);
    }

    {# Nunjucks loop calling js #}
    {% for address in params.matched_addresses %}

      {# js function to save a new address and details in json #}
      {# This should only include attributes a user might want to see raw #}
      {# Attributes that generate content (like hirderachey) should be missed here #}

      addAddressToLargeList({
        // High level attributes (common)
        uprn: {{ address.uprn.value | tojson }},
        formattedAddress: {{ address.formatted_address.value | tojson }},
        longitude: {{ address.geo.value.longitude | tojson }},
        latitude: {{ address.geo.value.latitude  | tojson }},
        confidenceScore: {{ address.confidence_score.value | tojson }},
        underlyingScore: {{ address.underlying_score.value | tojson }},
        parentUprn: {{ address.parent_uprn.value | tojson }},

        // High level attributes (less vibey)
        formattedAddressNag: {{ address.formatted_address_nag.value | tojson }},
        formattedAddressPaf: {{ address.formatted_address_paf.value | tojson }},
        welshFormattedAddressNag: {{ address.welsh_formatted_address_nag.value | tojson }},
        welshFormattedAddressPaf: {{ address.welsh_formatted_address_paf.value | tojson }},
        classificationCode: {{ address.classification_code.value | tojson }},
        countryCode: {{ address.country_code.value | tojson }},
        lpiLogicalStatus: {{ address.lpi_logical_status.value | tojson }},

      });
    {% endfor %}

    // Set the values of the address for this page specifically
    setPageLocalValues( '{{params.page_name}}', {mostRecentlySearchedAddresses: matchedAddresses} )

    // Set these as the most recently searched addresses for global pages (like carrying the confidence score over to the info page!)
    setGlobalValues( {mostRecentlySearchedAddresses: matchedAddresses} )

  </script>

{% endmacro %}
