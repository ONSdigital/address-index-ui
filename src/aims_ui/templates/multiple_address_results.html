{% extends 'base.html' %}

{% from "components/phase-banner/_macro.njk" import onsPhaseBanner %}
{% from "components/input/_macro.njk" import onsInput %}
{% from "components/upload/_macro.njk" import onsUpload %}
{% from "components/button/_macro.njk" import onsButton %}
{% from "components/panel/_macro.njk" import onsPanel %}
{% from 'custom_search/_macro.njk' import customSearch %}
{% from "components/radios/_macro.njk" import onsRadios %}
{% from "components/question/_macro.njk" import onsQuestion %}
{% from "components/table/_macro.njk" import onsTable %}
{% from "components/section-navigation/_macro.njk" import onsSectionNavigation %}

{% block main %}

<h1>Match Multiple Addresses</h1>

<br>
<h1 id="tempid"></h1>

{{ onsSectionNavigation({
        "id": "section-menu",
        "currentPath": 'multiple_address_results',
        "itemsList": [
            {
                "title": "Under 5K Addresses",
                "url": url_for('multiple_address_original'),
            },
            {
                "title": "Over 5K Addresses",
                "url": url_for('multiple_address'),
            },
            {
                "title": "Monitor Jobs",
                "url":'multiple_address_results',
            },
        ]
}) }}

<br>
{{onsPanel({
"body": "<p>You can find previously submitted jobs, and their statuses here.</p>
<p>If a job is in the status 'results-exported' it can be downloaded.</p>
<p>There can be 1-hour delay between 'processing-finished' and 'results-exported'.</p>"
    })}}
<br>

{{ onsTable({
	'caption': 'Jobs',
	'id': 'adjustLinksTable',
	'ths': jobs.get('ths'),
	'trs': jobs.get('trs'),
	'variants': 'responsive',
	})}}

<script type=module src="static/src/all_pages_js.mjs"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.3/pako.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

 
<script>

function getAllLinks() {
  const tableLinks = [];
  const table = document.querySelector('#adjustLinksTable');
  const links = table.querySelectorAll('a');
  for (const link of links) {
    tableLinks.push({'link': link, 'parent': link.parentNode });
  }
  return tableLinks;
}

function downloadAndProcess(url) {
  console.log(url);
  fetch(url)
    .then(response => response.arrayBuffer())
    .then(arrayBuffer => pako.inflate(arrayBuffer))
    .then(inflated => new TextDecoder().decode(inflated))
    .then(csvString => Papa.parse(csvString).data)
    .then(rows => {
      rows.forEach(row => {
        row.forEach(element => {
          console.log(element);
        });
      });
    });
  return 'NA';
}


function changeLinkToButton(linkParent) {
  const newButton = document.createElement('button');
  newButton.textContent = 'Download Results';
  linkParent.parent.append(newButton);
  newButton.addEventListener('click', function() {
    // Get CSV content
    const csv = downloadAndProcess(linkParent.link.href);

    // Make a new blob
    const blob = new Blob([csv], { type: 'text/csv' });

    // Make 'a' with link to finalised csv content, then download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = linkParent.link.textContent + '.csv';
    a.click();
  });
}

window.addEventListener('load', function() {
  const linksAndParents = getAllLinks();
  for (const l of linksAndParents) {
    changeLinkToButton(l);
  }
});


</script>







{% endblock %}
