{% extends 'base.html' %}

{% from "components/phase-banner/_macro.njk" import onsPhaseBanner %}
{% from "components/input/_macro.njk" import onsInput %}
{% from "components/upload/_macro.njk" import onsUpload %}
{% from "components/button/_macro.njk" import onsButton %}
{% from "components/panel/_macro.njk" import onsPanel %}
{% from 'custom_search/_macro.njk' import customSearch %}
{% from "components/radios/_macro.njk" import onsRadios %}
{% from "components/question/_macro.njk" import onsQuestion %}
{% from "components/table/_macro.njk" import onsTable %}
{% from "components/section-navigation/_macro.njk" import onsSectionNavigation %}

{% block main %}

<h1>Match Multiple Addresses</h1>

<br>
<h1 id="tempid"></h1>

{{ onsSectionNavigation({
        "id": "section-menu",
        "currentPath": 'multiple_address_results',
        "itemsList": [
            {
                "title": "Under 5K Addresses",
                "url": url_for('multiple_address_original'),
            },
            {
                "title": "Over 5K Addresses",
                "url": url_for('multiple_address'),
            },
            {
                "title": "Monitor Jobs",
                "url":'multiple_address_results',
            },
        ]
}) }}

<br>
{{onsPanel({
"body": "<p>You can find previously submitted jobs, and their statuses here.</p>
<p>If a job is in the status 'results-exported' it can be downloaded.</p>
<p>There can be 1-hour delay between 'processing-finished' and 'results-exported'.</p>"
    })}}
<br>

{{ onsTable({
	'caption': 'Jobs',
	'id': 'adjustLinksTable',
	'ths': jobs.get('ths'),
	'trs': jobs.get('trs'),
	'variants': 'responsive',
	})}}

<script type=module src="static/src/all_pages_js.mjs"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.3/pako.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

 
<script>

function getAllLinks() {
  const tableLinks = [];
  const table = document.querySelector('#adjustLinksTable');
  const links = table.querySelectorAll('a');
  for (const link of links) {
    tableLinks.push({'link': link, 'parent': link.parentNode });
  }
  return tableLinks;
}

function getAddressesFromResponse(apiResponse) {
  // Given an API response (string), extract a list of all matched addresses, confidence score, document score
  // Extract the list of matched addresses
  const matchedAddresses = [];
  const jsonResponse = JSON.parse(apiResponse);
  const response = jsonResponse['response'];
  const addresses = response['addresses'];
  // Get the values needed for each address
  let i = 0;
  for (const address of addresses) {
    i = i + 1;
    const formattedAddress = address['formattedAddress'];
    const uprn = address['uprn'];
    const matchType = addresses.length > 1 ? 'M' : 'S'; 
    const confidenceScore = address['confidenceScore'];
    const documentScore = address['underlyingScore'];
    const rank = i;
    const addressToAdd = [formattedAddress, uprn, matchType, confidenceScore, documentScore, rank];
    matchedAddresses.push(addressToAdd);
  }
  console.log(matchedAddresses);
}

function processRow(row) {
  // Process [id, inputAddress, APIresponse]
  // to be in same format as <5k match
  // console.log(row); Â ['119113', '5 SOWTON EX8 9DD', '{"apiVersion":"1.0.1

  // Check not blank or header row
  if (row.length !== 3) { return '' }
  if (row[2].toString() === 'response') { return '' }

  const id = row[0];
  const inputAddress = row[1];
  const matchedAddresses = getAddressesFromResponse(row[2]);

  return ',nothing'
}

function downloadAndProcess(url) {
  console.log(url);
  let final_csv = '';
  fetch(url)
    .then(response => response.arrayBuffer())
    .then(arrayBuffer => pako.inflate(arrayBuffer))
    .then(inflated => new TextDecoder().decode(inflated))
    .then(csvString => Papa.parse(csvString).data)
    .then(rows => {
      rows.forEach(row => {
	// Row = [id, inputAddress, APIresponse]
	final_csv = final_csv + processRow(row);
      });
    });
  return 'NA';
}


function changeLinkToButton(linkParent) {
  const newButton = document.createElement('button');
  newButton.textContent = 'Download Results';
  linkParent.parent.append(newButton);
  newButton.addEventListener('click', function() {
    // Get CSV content
    const csv = downloadAndProcess(linkParent.link.href);

    // Make a new blob
    const blob = new Blob([csv], { type: 'text/csv' });

    // Make 'a' with link to finalised csv content, then download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = linkParent.link.textContent + '.csv';
    a.click();
  });
}

window.addEventListener('load', function() {
  const linksAndParents = getAllLinks();
  for (const l of linksAndParents) {
    changeLinkToButton(l);
  }
});


</script>







{% endblock %}
